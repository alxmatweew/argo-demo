apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: victoria-metrics
  namespace: argocd
spec:
  project: default
  source:
    repoURL: 'https://victoriametrics.github.io/helm-charts/'
    targetRevision: "0.25.14"
    helm:
      parameters:
         - name: nameOverride
           value: "vm"
         - name: defaultDashboardsEnabled
           value: "false"
         - name: experimentalDashboardsEnabled
           value: "false"
         - name: alertmanager.enabled
           value: "false"
         - name: vmalert.enabled
           value: "false"
         - name: grafana.enabled
           value: "false"
         # - name: kubeEtcd.service.port
         #   value: "2381"
         # - name: kubeEtcd.service.targetPort
         #   value: "2381"

         # - name: kubeEtcd.vmScrape.spec.endpoints.scheme
         #   value: "http"

      values: |
        kubeScheduler:
          enabled: true
          endpoints: []
          service:
            enabled: true
            port: 10259
            targetPort: 10259
            selector:
              component: kube-scheduler
          vmScrape:
            spec:
              jobLabel: jobLabel
              namespaceSelector:
                matchNames: [kube-system]
              endpoints:
                - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
                  port: http-metrics
                  scheme: https
                  tlsConfig:
                    caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
                    insecureSkipVerify: true
                    serverName: kubernetes
        kubeControllerManager:
          enabled: true
          endpoints: []
          service:
            enabled: true
            port: 10257
            targetPort: 10257
            selector:
              component: kube-controller-manager
          vmScrape:
            spec:
              jobLabel: jobLabel
              namespaceSelector:
                matchNames: 
                  - "kube-system"
              endpoints:
                - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
                  port: http-metrics
                  scheme: https
                  tlsConfig:
                    caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
                    insecureSkipVerify: true
                    serverName: kubernetes
        kubeEtcd:
          enabled: true
          endpoints: []
          service:
            enabled: true
            port: 2381
            targetPort: 2381
            selector:
              component: etcd
          vmScrape:
            spec:
              jobLabel: jobLabel
              namespaceSelector:
                matchNames: [kube-system]
              endpoints:
                - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
                  port: http-metrics
                  scheme: http
                  tlsConfig:
                    caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        vmagent:
          enabled: true
          annotations: {}
          additionalRemoteWrites:
            []
          spec:
            port: "8429"
            selectAllByDefault: true
            image:
              tag: v1.103.0
            scrapeInterval: 20s
            externalLabels: {}
            extraArgs:
              promscrape.streamParse: "true"
              promscrape.dropOriginalLabels: "false"
         
    chart: victoria-metrics-k8s-stack #vm/victoria-metrics-k8s-stack
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: vm2
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
